name: Publish PyPI and TestPyPI

on: push

jobs:
  build-n-publish:
    name: Build and publish to PyPI and TestPyPI
    runs-on: ubuntu-18.04

    steps:
    - name: Notify Start
      uses: innocarpe/actions-slack@v1
      with:
        status: ${{ job.status }} # Required
        success_text: '@${{ github.actor }} just started the workflow for `${{ github.ref }}`'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Required
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }} # Required

    - uses: actions/checkout@master

    - name: Set up Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7

    - name: Install dependencies
      run: python -m pip install --upgrade pip setuptools wheel twine

    - name: Build With setup.py
      run: |
        python setup.py sdist
        python setup.py bdist_wheel

    - name: Publish distribution to Test PyPI
      if: github.event_name == 'push'
      # This will fail if release already exists, should we use  --skip-existing
      run: scripts/publish.sh -u __token__ -p ${{ secrets.pypitoken_test }} --index https://test.pypi.org/legacy

    - name: Publish distribution to PyPI
      if: startsWith(github.ref, 'refs/tags')
      run: scripts/publish.sh -u __token__ -p ${{ secrets.pypitken }}

    - name: Notify Results
      if: always()
      uses: innocarpe/actions-slack@v1
      with:
        status: ${{ job.status }} # Required
        success_text: 'Step Succeeded üöÄ' # Optional
        failure_text: 'Step Failed üò±' # Optional
        cancelled_text: 'Step Cancelled ‚ö†Ô∏è' # Optional
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Required
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }} # Required
